# 命令手册 - 功能特性文档 (v1.3)

本文档详细列出了“命令手册”项目当前版本的所有功能，旨在为开发、测试和用户提供一份全面的参考。

---

## 目录
1.  [**核心理念**](#1-核心理念)
2.  [**界面与布局 (UI & Layout)**](#2-界面与布局-ui--layout)
3.  [**命令管理 (Command Management)**](#3-命令管理-command-management)
4.  [**分类与组织 (Category & Organization)**](#4-分类与组织-category--organization)
5.  [**搜索与过滤 (Search & Filtering)**](#5-搜索与过滤-search--filtering)
6.  [**数据与持久化 (Data & Persistence)**](#6-数据与持久化-data--persistence)
7.  [**核心技术与架构 (Core Tech & Architecture)**](#7-核心技术与架构-core-tech--architecture)
8.  [**用户体验与辅助功能 (UX & Accessibility)**](#8-用户体验与辅助功能-ux--accessibility)

---

## 1. 核心理念
- **高效管理**: 提供一个集中、高效的平台，用于存储、查找和构建日常使用的命令行指令。
- **智能辅助**: 通过智能解析、参数分类和构建建议，降低复杂命令的使用门槛。
- **高度可定制**: 用户可以自由创建、分类和标记自己的命令，打造个性化的命令库。

## 2. 界面与布局 (UI & Layout)

### 2.1 主体布局 (`App.vue`)
- **双栏结构**:
  - **左侧边栏 (`app-sidebar`)**: 用于展示分类树 (`CategoryTree`)。
  - **右侧主内容区 (`app-main`)**: 使用 Vue Router (`router-view`) 展示核心视图，如 `Home.vue`。
- **可拖拽的侧边栏 (`ResizeBorder.vue`)**:
  - **宽度调整**: 用户可以通过鼠标拖动侧边栏右侧的分割线，自由调整其宽度。
  - **范围限制**: 宽度可在 `250px` (最小) 到 `500px` (最大) 之间调整。
  - **状态持久化**: 调整后的宽度会自动保存到 `localStorage` (`sidebar-width`)，下次打开时恢复。
  - **双击重置**: 双击分割线可将宽度重置为默认值 `300px`。
  - **触摸支持**: 支持在移动设备上通过触摸进行拖拽。
  - **拖拽状态**: 拖拽时，鼠标指针变为 `col-resize`，并禁止页面其他元素的交互，以提供流畅体验。
- **全局组件**:
  - **消息提示 (`Toast.vue`)**: 用于显示全局的操作成功、失败或警告信息。

### 2.2 主视图 (`Home.vue`)
- **顶部操作区**:
  - **全局搜索栏**: 提供一个始终置顶的搜索框。
  - **快捷操作按钮**: 包括 `新建命令`, `批量新增`, `命令构建器`, `新建工作流`。按钮文本会根据模态框的显示状态动态变化（例如，“新建命令”变为“取消新建”）。
- **标签筛选区**:
  - 动态显示当前所有命令中存在的标签。
  - 显示每个标签关联的命令数量。
  - 支持多选标签进行 `AND` 逻辑过滤。
  - 提供“清除全部”按钮快速取消所有标签筛选。
  - 标签数量过多时（超过20个），自动折叠，并提供“显示全部”按钮。
- **命令列表区**:
  - **头部信息**: 显示当前分类/搜索结果的标题和命令总数。如果处于搜索或标签过滤状态，会显示对应的提示标签。
  - **命令卡片列表 (`CommandCard.vue`)**: 垂直排列所有命令卡片。
  - **分类同步显示**: 点击分类树中的任一分类时，命令列表会立即更新显示该分类下的所有命令。系统采用 Store 统一的过滤逻辑确保分类选择与命令显示的一致性。
  - **自动清除过滤**: 当选择新分类时，系统会自动清除之前的搜索查询和标签筛选，确保显示该分类的完整命令集合。
  - **空状态提示**: 当没有命令时，会根据上下文（是否在搜索）显示不同的提示信息和操作按钮（如"新建命令"或"清除筛选"）。
- **拖拽排序**:
  - 使用 `Sortable.js` 实现。
  - 用户可以在命令列表区域拖动命令卡片 (`.command-drag-handle`) 来调整其显示顺序。
  - 排序结果会被保存。

## 3. 命令管理 (Command Management)

### 3.1 命令的完整结构
- **基础属性**: `id`, `name`, `command` (模板), `description`。
- **组织属性**: `category` (分类ID), `tags` (标签数组)。
- **参数定义**: `parameters` (参数对象数组), `options` (选项对象数组), `separators` (分隔符数组)。
- **元数据**: `isUserCreated` (是否用户创建), `createdAt`, `updatedAt`, `usageCount` (使用次数), `lastUsed` (上次使用时间), `isDeleted`, `deletedAt` (软删除标记)。

### 3.2 命令卡片 (`CommandCard.vue`)
- **信息展示**:
  - **头部**: 显示命令名称、描述和“自定义”标签（如果适用）。
  - **命令预览**: 以代码块形式展示命令模板。
  - **参数统计**: 直观展示 `必选`、`可选`、`选项级` 参数的数量。
  - **标签列表**: 显示命令的前3个标签，多余的会折叠。
  - **使用统计**: 显示命令的使用次数和上次使用的大致时间（如“今天使用”、“3天前”）。
- **快捷操作**:
  - **卡片点击**: 默认触发“查看详情”事件。
  - **按钮组**:
    - **复制**: 一键复制命令模板到剪贴板。
    - **构建**: 打开“智能构建器”模态框。
    - **执行**: 快速执行命令（带参数时会弹出输入框）。
  - **更多菜单 (Dropdown)**:
    - `查看详情`: 打开 `CommandDetailModal`。
    - `编辑命令`: 打开 `CommandAddModal` 并填充现有数据。
    - `复制为新命令`: 打开 `CommandAddModal` 并填充为新命令。
    - `删除命令`: 触发删除流程。

### 3.3 创建与编辑 (`CommandAddModal.vue`)
- **模式复用**: 同一个模态框用于“新建”和“编辑”命令。
- **智能解析**: 支持从粘贴的完整命令中自动提取参数占位符 `{{...}}`。
- **可视化编辑**:
  - 提供表单来编辑命令的所有属性。
  - 支持动态添加、删除和编辑 `参数`、`选项` 和 `分隔符`。
- **校验**: 对命令名称、内容等进行基础校验。

### 3.4 智能命令构建器 (`CommandBuilderModal.vue`)
- **交互式构建**:
  - 用户可以点选 `选项`、`参数` 和 `分隔符` 将它们追加到命令中。
  - **双向同步**: 在文本框中手动修改命令，会反向更新选项和参数的选中状态。
- **模板使用**: 可以基于一个现有的命令模板进行构建。
- **参数填充**: 为需要输入的参数提供输入框，并支持插入占位符。
- **实时预览**: 构建的命令会实时显示在文本框中。
- **直接编辑**: 用户可以直接在预览框中手动输入或修改命令。
- **后续操作**: 构建完成的命令可以被 `复制`、`执行` 或 `另存为新命令`。

### 3.5 批量操作
- **批量新增 (`BatchCreateModal.vue`)**: 支持通过粘贴 JSON 数组来一次性创建多个命令。
- **批量迁移 (`BatchMigrateModal.vue`)**: 在主视图中，可以将当前分类下的所有命令一次性移动到另一个分类。

### 3.6 删除与恢复
- **软删除**: 用户创建的命令和分类在删除时，会先被移入“回收站”，而不是物理删除。
- **恢复**: 在“回收站”中，可以恢复被删除的命令或分类。
- **永久删除**: 在“回收站”中，可以对单个项目或整个回收站进行清空，实现永久删除。
- **隐藏**: 预置的示例命令不能被删除，但可以被“隐藏”。

### 3.7 其他模态框
- **详情查看 (`CommandDetailModal.vue`)**: 以只读方式展示命令的完整信息。
- **参数输入 (`ParameterModal.vue`)**: 当执行带参数的命令时，弹出此模态框要求用户输入参数值。
- **通用确认框 (`ConfirmModal.vue`)**: 用于执行危险操作（如删除）前的二次确认。

## 4. 分类与组织 (Category & Organization)

### 4.1 分类树 (`CategoryTree.vue`)
- **树状结构**:
  - 支持最多四级嵌套的父子分类。
  - 使用不同颜色和缩进来区分层级。
- **系统分类**:
  - **最近使用**: 自动记录最近使用过的10条命令。
  - **回收站**: 存放被软删除的命令和分类。
- **交互功能**:
  - **展开/折叠**:
    - 点击分类前的箭头可以展开或折叠该分类。
    - 顶部提供“全部展开/收回”按钮。
    - 展开状态会被保存到 `localStorage`。
  - **命令计数**: 每个分类旁边会显示其直接包含的命令数量。
  - **拖拽排序**:
    - 支持在同一层级内拖拽分类进行排序。
    - 支持将一个分类从一个父级拖拽到另一个父级，实现跨级移动。
    - 拖拽操作会实时更新分类的顺序和层级关系。
- **内联管理 (Inline Editing)**:
  - **直接创建**: 点击“+”号可直接在树中创建新的顶级或子级分类，无需打开模态框。
  - **直接编辑**: 双击分类名称可直接进入编辑模式。
  - **快捷操作**: 使用 `Enter` 保存，`Escape` 取消。

## 5. 搜索与过滤 (Search & Filtering)

- **实时搜索 (`Home.vue`)**:
  - **触发方式**: 在搜索框输入文本即时触发。
  - **搜索逻辑**: 使用 `Fuse.js` 进行模糊搜索。
  - **搜索范围**: `名称`, `描述`, `命令模板`, `标签`。
  - **快捷键**: `Ctrl+K` 可快速聚焦到搜索框。
- **搜索历史**:
  - **自动保存**: 自动记录最近的20条搜索历史。
  - **快捷访问**: 通过搜索框旁边的“时钟”图标下拉菜单，可以快速选择历史记录。
  - **清空历史**: 下拉菜单中提供清空所有历史记录的选项。
- **标签过滤 (`Home.vue`)**:
  - **多选过滤**: 可以同时选中多个标签，逻辑为 `AND`（即命令需同时包含所有选中标签）。
  - **状态显示**: 标签被选中后会高亮，并可通过标签上的“x”号单独移除。

## 6. 数据与持久化 (Data & Persistence)

### 6.1 状态管理 (`src/stores/command.js`)
- **Pinia**: 作为全应用的状态管理中心。
- **核心 Store (`useCommandStore`)**:
  - `commands`: 存储所有命令对象。
  - `categories`: 存储所有分类对象。
  - `searchHistory`, `recentCommands`: 存储用户行为历史。
  - `sortPreferences`: 存储拖拽排序的顺序。
  - `buildHistory`: 存储命令构建历史。

### 6.2 数据持久化
- **存储机制**:
  - 优先使用 `utoolsDB` (若在 uTools 环境中)。
  - 降级使用浏览器 `localStorage`。
- **存储内容**:
  - **用户数据**: 用户创建的命令和分类。
  - **用户行为**: 搜索历史、最近使用命令、构建历史。
  - **UI状态**: 侧边栏宽度、分类树展开状态、排序偏好。
- **数据加载**:
  - **示例数据**: 应用启动时会加载 `git-commands-processed.json` 和 `updated-commands.json` 作为预置的示例命令。
  - **用户数据**: 随后会加载并合并本地存储的用户数据。

## 7. 核心技术与架构 (Core Tech & Architecture)

### 7.1 增强的命令系统 (`commandManager.js`, `parameterClassification.js`)
- **命令管理器 (`commandManager`)**: 一个集成的模块，负责命令的 `创建`、`构建`、`验证` 和 `分析`。
- **参数分类器 (`parameterClassifier`)**:
  - 能够自动将参数分为 `必选`、`可选`、`条件性`。
  - 识别参数的级别（`命令级`, `选项级`, `全局`）。
- **参数升级**: `upgradeCommandParameters` 方法可以将旧的、简单的参数定义动态升级为包含完整分类信息的新结构，用于展示和构建。
- **智能建议**: `getCommandSuggestions` 方法可以根据命令定义，为构建器提供下一步操作的建议。

### 7.2 全局事件与快捷键
- **全局事件**: 使用 `window.dispatchEvent` 和 `window.addEventListener` 实现简单的全局事件总线，用于解耦组件间的通信（如触发模态框显示）。
- **快捷键系统 (`main.js`, `keyboard.js`)**:
  - `Ctrl+K`: 聚焦搜索框。
  - `Ctrl+N`: 触发“新建命令”模态框。
  - `Ctrl+B`: 触发“命令构建器”模态框。

## 8. 用户体验与辅助功能 (UX & Accessibility)

- **主题定制 (`theme.js`)**:
  - 支持 `亮色/暗色` 模式，并能跟随系统设置。
  - 提供 CSS 变量供用户未来定制 `主色调`、`圆角` 等。
- **全局样式**:
  - **滚动条**: 对滚动条进行了美化，使其更纤细、不突兀。
  - **文本选择**: 自定义了全局文本选中的背景色和前景色。
  - **焦点样式**: 为可聚焦元素提供了清晰的 `outline` 样式。
- **无障碍**:
  - **减少动画**: 遵循 `prefers-reduced-motion` 媒体查询，在用户启用该设置时禁用或减少不必要的动画。
  - **打印样式**: 提供了特定的打印样式，在打印时会自动隐藏侧边栏等非内容元素。
- **响应式设计**: 关键组件（如主视图、卡片）在不同屏幕尺寸下有合理的布局调整。 

---

## 更新记录

### v1.3 - 设置系统重构 (三级导航)
- **三级导航结构**: 重构了应用设置系统，采用分层次的设置管理：
  - **主分类**: 命令卡片、通用设置、高级设置
  - **子分类**: 命令卡片包含显示设置、行为设置、布局设置
  - **设置内容**: 具体的配置选项和开关
- **智能复制系统**: 
  - 实现了智能默认复制命令管理
  - 支持常用完整命令收藏和管理
  - 可配置自动更新最近使用命令为默认复制
- **可配置显示**: 
  - 命令卡片的所有显示元素均可独立配置
  - 提供快速预设 (极简、标准、详细)
  - 支持紧凑模式和详细模式切换
- **设置访问优化**: 固定右上角设置按钮，清晰的导航路径

### v1.2 - 命令卡片重设计 (水平布局)
- **新型水平布局**: 重新设计了 `CommandCard.vue`，采用从左到右的布局方式：
  - **最近使用命令** (左侧): 显示命令名称、最近使用的完整命令、描述
  - **分类标签** (中左): 显示命令所属分类
  - **标签区域** (中右): 显示前3个标签，多余显示"+N"
  - **操作按钮** (右侧): 简化的操作按钮组
- **交互优化**: 
  - 单击卡片复制最近使用的完整命令
  - 双击卡片进入智能构建器
- **性能提升**: 移除渲染时的参数升级计算，实现超快速分类切换

### v1.4 - 无限滚动与混合浏览模式
- **无限滚动机制**: 完整实现无限滚动功能
  - **数据追加**: 滚动到底部时自动追加下一页数据，而非替换
  - **累积显示**: 支持连续浏览所有命令内容
  - **性能优化**: 基于全局索引的高效数据加载
  - **默认模式**: 无限滚动成为主要浏览模式，符合现代应用体验
  - **静默加载**: 无限滚动模式下快速安静加载，无进度提示和聚焦干扰
- **大数据量优化**: 多重优化策略保证海量数据下的流畅体验
  - **虚拟滚动**: 超过100条命令自动启用虚拟滚动，只渲染可见部分
  - **分片索引构建**: 使用requestAnimationFrame分片处理，避免阻塞UI
  - **高效过滤**: Set数据结构优化标签查找，预编译搜索条件
  - **性能监控**: 自动检测查询耗时，超过10ms发出性能警告
  - **零延迟切换**: 基于预构建索引实现毫秒级分类切换
- **灵活浏览模式**: 支持多种浏览方式选择
  - **无限滚动（默认）**: 主要浏览模式，适合连续浏览和探索
  - **传统分页（可选）**: 为习惯传统分页的用户提供选择，包含加载反馈
  - **混合模式**: 可同时启用两种模式，提供最大灵活性
  - **智能初始化**: 确保首屏加载足够内容以触发滚动
- **设置界面优化**: 
  - **模式导向**: 以"无限滚动（推荐）"为主，"传统分页器"为辅
  - **实时状态**: 动态显示当前浏览模式配置
  - **用户引导**: 清晰的功能描述和使用建议 